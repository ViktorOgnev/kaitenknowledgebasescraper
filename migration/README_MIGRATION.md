# Миграция данных между аккаунтами Kaiten

## Что переносится

Скрипт переносит следующие данные из одного аккаунта Kaiten в другой:

1. ✅ **Пользовательские поля** (custom properties) — все типы полей включая "Справочник"
2. ✅ **Метки (теги)** — с сохранением цветов
3. ✅ **Пространства** (spaces) — структура папок
4. ✅ **Доски** (boards) — со всеми настройками
5. ✅ **Колонки и дорожки** — структура досок
6. ✅ **Карточки** (cards) — с описаниями, сроками, размерами, пользовательскими полями
7. ✅ **Комментарии** — все комментарии к карточкам
8. ✅ **Чек-листы** — с пунктами и статусами выполнения
9. ✅ **Связи карточек** — родительские/дочерние связи

## Что НЕ переносится

❌ **Пользователи** — нужно создать вручную в целевом аккаунте
❌ **Файлы/вложения** — из-за ограничений API (нужна отдельная реализация)
❌ **История изменений** — сохраняются только текущие состояния
❌ **Права доступа** — нужно настроить вручную после миграции
❌ **Автоматизации** — нужно пересоздать вручную
❌ **Ответственные/участники карточек** — т.к. пользователи разные

## Установка

### 1. Установите Python 3.7+

```bash
python3 --version
```

### 2. Установите зависимости

```bash
cd /Users/name/Downloads/kaitendocs/
pip3 install -r requirements.txt
```

## Получение API токенов

### В исходном аккаунте:
1. Откройте https://ваш-домен.kaiten.ru
2. Настройки → API → Создать токен
3. Скопируйте токен

### В целевом аккаунте:
1. Откройте https://новый-домен.kaiten.ru
2. Настройки → API → Создать токен
3. Скопируйте токен

## Запуск миграции

```bash
python3 kaiten_migration.py
```

### Пример диалога:

```
================================================================================
МИГРАЦИЯ ДАННЫХ МЕЖДУ АККАУНТАМИ KAITEN
================================================================================

ИСХОДНЫЙ АККАУНТ:
  Домен (например, 'company'): mycompany
  API Token: 296a5709-99bc-49a7-96e0-c0a1b236091f

ЦЕЛЕВОЙ АККАУНТ:
  Домен (например, 'newcompany'): newcompany
  API Token: 8f3c2e1d-44bb-22c8-11a9-9d2e8c7b6a5f

ВНИМАНИЕ!
Данные будут скопированы из 'mycompany' в 'newcompany'
Продолжить? (yes/no): yes
```

## Что происходит при миграции

### 1. Пользовательские поля (1-2 мин)
```
--- Миграция пользовательских полей ---
Создание пользовательского поля: Клиент
✓ Поле создано: Клиент (ID: 123 -> 456)
```

### 2. Метки (1 мин)
```
--- Миграция меток ---
Создание метки: Срочно
✓ Метка создана: Срочно
```

### 3. Пространства и доски (2-5 мин)
```
--- Миграция пространств и досок ---
Создание пространства: CRM
✓ Пространство создано: CRM (ID: 10 -> 20)
  Создание доски: Лиды
  ✓ Доска создана: Лиды (ID: 50 -> 60)
```

### 4. Карточки (5-30 мин, зависит от количества)
```
--- Миграция карточек ---
Найдено карточек: 1523
  Создание карточки: Лид от ООО Рога и копыта
  ✓ Карточка создана (ID: 1001 -> 2001)
```

### 5. Комментарии (5-15 мин)
```
--- Миграция комментариев ---
Комментариев перенесено: 3456/3456
```

### 6. Чек-листы (3-10 мин)
```
--- Миграция чек-листов ---
Чек-листов перенесено: 234/234
```

### 7. Связи карточек (2-5 мин)
```
--- Миграция связей карточек ---
Связей перенесено: 567
```

## Статистика в конце

```
================================================================================
СТАТИСТИКА МИГРАЦИИ
================================================================================
CUSTOM_PROPERTIES................. 15/15 (100.0%) [Ошибок: 0]
TAGS.............................. 42/42 (100.0%) [Ошибок: 0]
SPACES............................ 5/5 (100.0%) [Ошибок: 0]
BOARDS............................ 12/12 (100.0%) [Ошибок: 0]
CARDS............................. 1523/1523 (100.0%) [Ошибок: 0]
COMMENTS.......................... 3456/3456 (100.0%) [Ошибок: 0]
CHECKLISTS........................ 234/234 (100.0%) [Ошибок: 0]
================================================================================
```

## Лог файл

Все действия сохраняются в файл:
```
kaiten_migration_20251204_153045.log
```

## Rate Limiting

Скрипт автоматически соблюдает лимит Kaiten API:
- **Максимум 5 запросов в секунду**
- При превышении лимита автоматически ждёт

## Время выполнения

Примерное время для разных объёмов:

| Карточек | Комментариев | Примерное время |
|----------|--------------|-----------------|
| 100 | 500 | ~5 минут |
| 500 | 2000 | ~15 минут |
| 1000 | 5000 | ~30 минут |
| 5000 | 20000 | ~2 часа |

## Что делать после миграции

### 1. Проверьте данные
- Откройте целевой аккаунт
- Проверьте пространства и доски
- Откройте несколько карточек, убедитесь что данные на месте

### 2. Назначьте пользователей
- В целевом аккаунте создайте пользователей
- Вручную назначьте ответственных на карточки

### 3. Настройте права доступа
- Для каждого пространства настройте права
- Для каждой доски проверьте доступы

### 4. Пересоздайте автоматизации
- Откройте исходный аккаунт
- Скопируйте настройки автоматизаций
- Создайте их в целевом аккаунте

### 5. Настройте интеграции
- Вебхуки
- Email-интеграции
- Телефонию (Sipnuv)
- Telegram/Slack боты

## Troubleshooting

### Ошибка "401 Unauthorized"
- Проверьте правильность API токенов
- Убедитесь, что токены не истекли

### Ошибка "429 Too Many Requests"
- Скрипт автоматически обрабатывает, просто подождите
- Если проблема повторяется, проверьте нет ли других клиентов API

### Карточки не создаются
- Проверьте, что доски уже созданы
- Посмотрите лог файл для деталей ошибки

### Пользовательские поля не заполнены в карточках
- Убедитесь, что пользовательские поля мигрировали первыми
- Проверьте маппинг ID в логе

## Безопасность

⚠️ **ВАЖНО:**
- Не коммитьте API токены в Git
- Удалите токены после миграции
- Лог файлы могут содержать чувствительные данные

## Поддержка

Если возникли проблемы:
1. Изучите лог файл
2. Найдите строку с ошибкой
3. Проверьте API документацию: https://developers.kaiten.ru
4. Напишите в поддержку Kaiten с приложением лога

## Ограничения API

- **Rate limit:** 5 запросов/секунду
- **Pagination:** максимум 100 записей за запрос
- **Timeout:** нет официального, но рекомендуется 30 секунд

## Дополнительные возможности

Если нужно мигрировать:
- **Файлы** — потребуется доработка скрипта (download → upload через API)
- **Пользователей** — можно через SCIM API (отдельная реализация)
- **Время трекинг** — через `/card-time-logs` эндпоинт
